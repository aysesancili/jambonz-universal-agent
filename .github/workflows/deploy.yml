name: Deploy to VM2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - uses: actions/checkout@v4

    - id: 'auth'
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: 'Set up Cloud SDK'
      uses: 'google-github-actions/setup-gcloud@v2'

    - name: 'Deploy to VM'
      run: |
        gcloud compute ssh ubuntu@instance-20250930-082652 --zone=us-central1-a --command="
          # Klasör yoksa clone'la, varsa pull yap
          if [ ! -d 'universal-agent' ]; then
            git clone https://github.com/aysesancili/jambonz-universal-agent.git universal-agent
            cd universal-agent
          else
            cd universal-agent
            git pull origin main
          fi
          
          # .env dosyasını oluştur (Secrets'tan)
          echo 'NODE_ENV=production' > .env
          echo 'LOG_LEVEL=info' >> .env
          echo 'PORT=3334' >> .env
          echo 'BACKEND_URL=${{ secrets.BACKEND_URL }}' >> .env
          echo 'BACKEND_API_KEY=${{ secrets.BACKEND_API_KEY }}' >> .env
          echo 'GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}' >> .env
          
          # Kurulum ve Başlatma
          npm install
          pm2 restart universal-agent || pm2 start ecosystem.config.js
          pm2 save
        "

